---
import Layout from '../../layouts/Layout.astro';

export function getStaticPaths() {
  return [];
}

const { id } = Astro.params;

interface Post {
  id: number;
  title: string;
  content: string;
  excerpt: string;
  category: string;
  tags: string;
  created_at: string;
  updated_at: string;
  author_name: string;
}

let post: Post | null = null;
let loading = true;
let error: string | null = null;

try {
  const response = await fetch(`/api/posts/${id}`);
  const data = await response.json();
  if (data.success) {
    post = data.post;
  } else {
    error = data.error || '加载文章失败';
  }
} catch (e) {
  error = '网络错误，请稍后重试';
  console.error(e);
}

loading = false;
---

<Layout title={post?.title || '文章详情'}>
  <div class="container py-8">
    {loading && (
      <div class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"></div>
        <p class="mt-4 text-gray-600">加载中...</p>
      </div>
    )}

    {error && (
      <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-red-800">
        {error}
      </div>
    )}

    {!loading && !error && post && (
      <article class="max-w-4xl mx-auto bg-white rounded-lg shadow p-8">
        <!-- 文章头部 -->
        <header class="mb-8 pb-6 border-b border-gray-200">
          <h1 class="text-4xl font-bold text-gray-900 mb-4">{post.title}</h1>
          <div class="flex flex-wrap items-center gap-4 text-sm text-gray-600">
            <span>发布于 {new Date(post.created_at).toLocaleDateString('zh-CN')}</span>
            {post.updated_at && new Date(post.updated_at).getTime() !== new Date(post.created_at).getTime() && (
              <span>· 更新于 {new Date(post.updated_at).toLocaleDateString('zh-CN')}</span>
            )}
            {post.category && (
              <>
                <span>·</span>
                <a href={`/categories/${encodeURIComponent(post.category)}`} class="hover:text-primary-600">
                  {post.category}
                </a>
              </>
            )}
            <span>·</span>
            <span>{post.author_name || '匿名'}</span>
          </div>
        </header>

        <!-- 文章内容 -->
        <div class="prose prose-lg max-w-none mb-8" set:html={post.content} />

        <!-- 标签 -->
        {post.tags && (
          <div class="mb-8 pb-6 border-b border-gray-200">
            <div class="flex flex-wrap gap-2">
              {post.tags.split(',').map((tag) => (
                <a
                  href={`/tags/${encodeURIComponent(tag.trim())}`}
                  class="inline-block px-3 py-1 bg-primary-50 text-primary-700 rounded-full text-sm hover:bg-primary-100"
                >
                  #{tag.trim()}
                </a>
              ))}
            </div>
          </div>
        )}

        <!-- 上一篇/下一篇导航 -->
        <nav class="flex justify-between items-center py-4">
          <div class="text-left">
            <a href="/" class="text-primary-600 hover:text-primary-700">
              ← 返回首页
            </a>
          </div>
        </nav>
      </article>
    )}

    <!-- Twikoo评论 -->
    {!loading && !error && post && (
      <div class="max-w-4xl mx-auto mt-8 bg-white rounded-lg shadow p-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">评论</h2>
        <div id="tcomment"></div>
      </div>
    )}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/twikoo@1.6.39/dist/twikoo.all.min.js"></script>
  <script>
    const twikooEnvId = import.meta.env.PUBLIC_TWIKOO_ENV_ID || 'your-twikoo-env-id';
    const twikooEl = document.getElementById('tcomment');

    if (twikooEl && twikooEnvId !== 'your-twikoo-env-id') {
      (window as any).twikoo.init({
        envId: twikooEnvId,
        el: '#tcomment',
        lang: 'zh-CN',
      });
    } else {
      twikooEl?.insertAdjacentHTML('beforeend', `
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-yellow-800">
          请在环境变量中配置 TWIKOO_ENV_ID 以启用评论功能
        </div>
      `);
    }
  </script>
</Layout>
