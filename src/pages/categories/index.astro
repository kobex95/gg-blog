---
import Layout from '../../layouts/Layout.astro';

interface Category {
  category: string;
  post_count: number;
}

let categories: Category[] = [];
let loading = true;
let error: string | null = null;

try {
  const response = await fetch('/api/categories');
  const data = await response.json();
  if (data.success) {
    categories = data.categories;
  } else {
    error = data.error || '加载分类失败';
  }
} catch (e) {
  error = '网络错误，请稍后重试';
  console.error(e);
}

loading = false;
---

<Layout title="分类">
  <div class="container py-8">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-3xl font-bold text-gray-900 mb-8">所有分类</h1>

      {loading && (
        <div class="text-center py-12">
          <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"></div>
          <p class="mt-4 text-gray-600">加载中...</p>
        </div>
      )}

      {error && (
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-red-800">
          {error}
        </div>
      )}

      {!loading && !error && categories.length === 0 && (
        <div class="text-center py-12 bg-white rounded-lg shadow">
          <p class="text-gray-600">暂无分类</p>
        </div>
      )}

      {!loading && !error && categories.length > 0 && (
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          {categories.map((cat) => (
            <a
              href={`/categories/${encodeURIComponent(cat.category)}`}
              class="bg-white rounded-lg shadow hover:shadow-lg transition-shadow p-6 block"
            >
              <h2 class="text-xl font-bold text-gray-900 mb-2">{cat.category}</h2>
              <p class="text-sm text-gray-600">{cat.post_count} 篇文章</p>
            </a>
          ))}
        </div>
      )}
    </div>
  </div>
</Layout>
