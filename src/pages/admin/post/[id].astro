---
import Layout from '../../../layouts/Layout.astro';
const { id } = Astro.params;
const token = Astro.cookies.get('token')?.value;

export const prerender = false;

if (!token) {
  return Astro.redirect('/admin');
}

let post: any = null;
let loading = true;
let error: string | null = null;

try {
  const response = await fetch(`/api/posts/${id}`);
  const data = await response.json();
  if (data.success) {
    post = data.post;
  } else {
    error = data.error || '加载文章失败';
  }
} catch (e) {
  error = '网络错误，请稍后重试';
  console.error(e);
}

loading = false;
---

<Layout title="编辑文章">
  <div class="container py-8">
    {loading && (
      <div class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"></div>
        <p class="mt-4 text-gray-600">加载中...</p>
      </div>
    )}

    {error && (
      <div class="max-w-4xl mx-auto bg-red-50 border border-red-200 rounded-lg p-4 text-red-800">
        {error}
      </div>
    )}

    {!loading && !error && post && (
      <div class="max-w-4xl mx-auto bg-white rounded-lg shadow p-8">
        <h1 class="text-2xl font-bold text-gray-900 mb-6">编辑文章</h1>
        
        <form id="postForm" class="space-y-6">
          <div>
            <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
              标题 *
            </label>
            <input
              type="text"
              id="title"
              name="title"
              value={post.title}
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
            />
          </div>
          
          <div>
            <label for="content" class="block text-sm font-medium text-gray-700 mb-2">
              内容 *
            </label>
            <textarea
              id="content"
              name="content"
              rows="20"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
            >{post.content}</textarea>
            <p class="text-sm text-gray-500 mt-1">支持HTML标签</p>
          </div>
          
          <div>
            <label for="excerpt" class="block text-sm font-medium text-gray-700 mb-2">
              摘要
            </label>
            <textarea
              id="excerpt"
              name="excerpt"
              rows="3"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
            >{post.excerpt || ''}</textarea>
          </div>
          
          <div>
            <label for="category" class="block text-sm font-medium text-gray-700 mb-2">
              分类
            </label>
            <input
              type="text"
              id="category"
              name="category"
              value={post.category || ''}
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
              placeholder="例如：技术、生活"
            />
          </div>
          
          <div>
            <label for="tags" class="block text-sm font-medium text-gray-700 mb-2">
              标签
            </label>
            <input
              type="text"
              id="tags"
              name="tags"
              value={post.tags || ''}
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
              placeholder="多个标签用逗号分隔，例如：JavaScript,Astro"
            />
          </div>
          
          <div>
            <label for="status" class="block text-sm font-medium text-gray-700 mb-2">
              状态
            </label>
            <select
              id="status"
              name="status"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
            >
              <option value="published" selected={post.status === 'published'}>已发布</option>
              <option value="draft" selected={post.status === 'draft'}>草稿</option>
            </select>
          </div>
          
          <div class="flex space-x-4">
            <button
              type="submit"
              class="flex-1 bg-primary-600 text-white px-6 py-3 rounded-lg hover:bg-primary-700 transition-colors font-medium"
            >
              更新文章
            </button>
            <button
              type="button"
              onclick="window.location.href='/admin'"
              class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"
            >
              取消
            </button>
          </div>
        </form>
        
        <div id="formError" class="hidden mt-4 bg-red-50 border border-red-200 rounded-lg p-4 text-red-800"></div>
      </div>
    )}
  </div>

  <script>
    const postForm = document.getElementById('postForm') as HTMLFormElement;
    const postId = { id: "{id}" }.id;

    postForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(postForm);
      const data = {
        title: formData.get('title'),
        content: formData.get('content'),
        excerpt: formData.get('excerpt'),
        category: formData.get('category'),
        tags: formData.get('tags'),
        status: formData.get('status'),
      };

      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/posts/${postId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
          },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (result.success) {
          alert('文章更新成功');
          window.location.href = '/admin';
        } else {
          showError(result.error || '更新失败');
        }
      } catch (error) {
        showError('网络错误，请稍后重试');
      }
    });

    function showError(message: string) {
      const errorDiv = document.getElementById('formError');
      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
      }
    }
  </script>
</Layout>
