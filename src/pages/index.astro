---
import Layout from '../layouts/Layout.astro';

interface Post {
  id: number;
  title: string;
  content: string;
  excerpt: string;
  category: string;
  tags: string;
  created_at: string;
  author_name: string;
}

let posts: Post[] = [];
let loading = true;
let error: string | null = null;

try {
  const response = await fetch('/posts');
  const data = await response.json();
  if (data.success) {
    posts = data.posts;
  } else {
    error = data.error || '加载文章失败';
  }
} catch (e) {
  error = '网络错误，请稍后重试';
  console.error(e);
}

loading = false;
---

<Layout title="首页">
  <div class="container py-8">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
      <!-- 主要内容区 -->
      <div class="lg:col-span-3">
        <div class="mb-8">
          <h1 class="text-3xl font-bold text-gray-900 mb-4">最新文章</h1>
          
          <!-- 搜索框 -->
          <div class="relative">
            <input
              type="search"
              id="searchInput"
              placeholder="搜索文章..."
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
            />
          </div>
        </div>

        <!-- 加载状态 -->
        {loading && (
          <div class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"></div>
            <p class="mt-4 text-gray-600">加载中...</p>
          </div>
        )}

        <!-- 错误状态 -->
        {error && (
          <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-red-800">
            {error}
          </div>
        )}

        <!-- 文章列表 -->
        {!loading && !error && posts.length === 0 && (
          <div class="text-center py-12 bg-white rounded-lg shadow">
            <p class="text-gray-600">暂无文章</p>
          </div>
        )}

        {!loading && !error && posts.length > 0 && (
          <div class="space-y-6" id="postsList">
            {posts.map((post) => (
              <article class="bg-white rounded-lg shadow hover:shadow-lg transition-shadow p-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-3">
                  <a href={`/post/${post.id}`} class="hover:text-primary-600">
                    {post.title}
                  </a>
                </h2>
                <div class="flex items-center space-x-4 text-sm text-gray-600 mb-4">
                  <span>{new Date(post.created_at).toLocaleDateString('zh-CN')}</span>
                  {post.category && (
                    <>
                      <span>·</span>
                      <a href={`/categories/${encodeURIComponent(post.category)}`} class="hover:text-primary-600">
                        {post.category}
                      </a>
                    </>
                  )}
                  <span>·</span>
                  <span>{post.author_name || '匿名'}</span>
                </div>
                {post.excerpt && (
                  <p class="text-gray-700 mb-4 line-clamp-3">{post.excerpt}</p>
                )}
                {post.tags && (
                  <div class="flex flex-wrap gap-2">
                    {post.tags.split(',').map((tag) => (
                      <a
                        href={`/tags/${encodeURIComponent(tag.trim())}`}
                        class="inline-block px-3 py-1 bg-primary-50 text-primary-700 rounded-full text-sm hover:bg-primary-100"
                      >
                        #{tag.trim()}
                      </a>
                    ))}
                  </div>
                )}
              </article>
            ))}
          </div>
        )}
      </div>

      <!-- 侧边栏 -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-lg shadow p-6 sticky top-8">
          <h3 class="text-lg font-bold text-gray-900 mb-4">快捷导航</h3>
          <ul class="space-y-2">
            <li>
              <a href="/" class="text-gray-700 hover:text-primary-600 block py-1">首页</a>
            </li>
            <li>
              <a href="/tags" class="text-gray-700 hover:text-primary-600 block py-1">标签</a>
            </li>
            <li>
              <a href="/categories" class="text-gray-700 hover:text-primary-600 block py-1">分类</a>
            </li>
            <li>
              <a href="/admin" class="text-gray-700 hover:text-primary-600 block py-1">管理后台</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  const searchInput = document.getElementById('searchInput') as HTMLInputElement;
  let searchTimeout: NodeJS.Timeout;

  searchInput?.addEventListener('input', (e) => {
    const searchTerm = (e.target as HTMLInputElement)?.value;
    
    clearTimeout(searchTimeout);
    
    searchTimeout = setTimeout(async () => {
      if (searchTerm.length > 0) {
        try {
          const response = await fetch(`/posts?search=${encodeURIComponent(searchTerm)}`);
          const data = await response.json();
          
          if (data.success) {
            renderPosts(data.posts);
          }
        } catch (error) {
          console.error('搜索失败:', error);
        }
      } else {
        location.reload();
      }
    }, 500);
  });

  function renderPosts(posts: any[]) {
    const postsList = document.getElementById('postsList');
    if (!postsList) return;

    if (posts.length === 0) {
      postsList.innerHTML = `
        <div class="text-center py-12 bg-white rounded-lg shadow">
          <p class="text-gray-600">未找到相关文章</p>
        </div>
      `;
      return;
    }

    postsList.innerHTML = posts.map((post) => `
      <article class="bg-white rounded-lg shadow hover:shadow-lg transition-shadow p-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-3">
          <a href="/post/${post.id}" class="hover:text-primary-600">
            ${post.title}
          </a>
        </h2>
        <div class="flex items-center space-x-4 text-sm text-gray-600 mb-4">
          <span>${new Date(post.created_at).toLocaleDateString('zh-CN')}</span>
          ${post.category ? `
            <span>·</span>
            <a href="/categories/${encodeURIComponent(post.category)}" class="hover:text-primary-600">
              ${post.category}
            </a>
          ` : ''}
          <span>·</span>
          <span>${post.author_name || '匿名'}</span>
        </div>
        ${post.excerpt ? `
          <p class="text-gray-700 mb-4 line-clamp-3">${post.excerpt}</p>
        ` : ''}
        ${post.tags ? `
          <div class="flex flex-wrap gap-2">
            ${post.tags.split(',').map((tag: string) => `
              <a href="/tags/${encodeURIComponent(tag.trim())}" class="inline-block px-3 py-1 bg-primary-50 text-primary-700 rounded-full text-sm hover:bg-primary-100">
                #${tag.trim()}
              </a>
            `).join('')}
          </div>
        ` : ''}
      </article>
    `).join('');
  }
</script>
